# 객체 지향 쿼리 언어
#TIL/JPA 기본/

---
## 객체지향 쿼리 언어 소개

### JPQL
- 애플리케이션이 필요한 데이터만 DB에서 불러오려면 결국 검색 조건이 포함된 SQL이 필요
- 엔티티 객체를 대상으로 쿼리

### Criteria
- 문자가 아닌 자바코드로 JPQL을 작성할 수 있음
- JPA 공식 기능
- 단점: 너무 복잡하고 실용성이 없다.
- 대신에 QueryDSL 사용 권장

### QueryDSL
- 문자가 아닌 자바코드로 JPQL을 작성
- 동적쿼리 작성 편리함
- 단순하고 쉬움
- 실무사용 권장

### 네이티브 SQL
- JPA가 제공하는 SQL을 직접 사용

### JDBC 직접 사용, SpringJdbcTemplate 등
- JPA를 사용하면서 JDBC커넥션을 직접 사용하거나, 스프링 JdbcTemplate, 마이바티스등을 함께 사용 가능

---

## JPQL(Java Persistence Query Language)
JPQL은 객체지향 쿼리 언어. 테이블을 대상으로 쿼리하는 것이 아니라 엔티티 객체를 대상으로 쿼리한다.

### JPQL 문법

```java
select m from Member as m where m.age > 18
```

- 엔티티 이름 사용, 테이블 이름이 아님(Member)
- 별칭은 필수(m) (as는 생략 가능)

### TypeQuery, Query
- TypeQuery: 반환 타입이 명확할 때 사용

```java
TypeQuery<Member> query = em.createQuery("SELECT m FROM Member m", Member.class);
```

- Query: 반환 타입이 명확하지 않을 때 사용

```java
Query query = em.createQuery("SELECT m.username, m.age from Member m");
```

### 결과 조회 API
- query.getResultList(): 결과가 하나 이상일 때, 리스트 반환
    - 결과가 없으면 빈 리스트 반환

- query.getSingleResult(): 결과가 정확히 하나, 단일 객체 반환
    - 결과가 없으면 NoResultException
    - 둘 이상이면 NoUniqueResultException

### 파라미터 바인딩

```java
SELECT m FROM Member m where m.username =:username
query.setParameter("username", usernameParam)
```

### 프로젝션
SELECT 절에 조회할 대상을 지정하는 것

- SELECT m FROM Member m -> 엔티티 프로젝션
- SELECT m.team FROM Member m -> 엔티티 프로젝션
- SELECT m.address FROM Member m -> 임베디드 타입 프로젝션
- SELECT m.username, m.age FROM Member m -> 스칼라 타입 프로젝션
- DISTINCT로 중복 제거

프로젝션 - 여러값 조회
1. Query 타입으로 조회
2. Object[] 타입으로 조회
3. new 명령어로 조회
    - 단순 값을 DTO로 바로 조회
        
        SELECT new jpabook.jpq.UserDTO(m.username, m.age)FROM Member m


### 페이징
페이징 API
- setFirstResult(int startPosition): 조회 시작 위치
- setMaxResults(int maxResult): 조회할 데이터 수.

### 조인
- 내부 조인:

    SELECT m FROM Member m [INNER] JOIN m.team t

- 외부 조인:
    
    SELECT m FROM Member m LEFT [OUTER] JOIN m.team t   

- 세타 조인:

    select count(m) from Member m, Team t where m.username = t.name

조인 - ON 절
- ON 절을 활용한 조인

1. 조인 대상 필터링

2. 연관관계 없는 엔티티 외부 조인

### 서브쿼리

ex) 나이가 평균보다 많은 회원

```java
select m from Member m where m.age > (select avg(m2.age) from Member m2)
```

서브쿼리 지원 함수
- EXISTS: 서브쿼리에 결과가 존재하면 참
    - ALL: 모두 만족하면 참
    - ANY, SOME: 같은 의미, 조건을 하나라도 만족하면 참
- IN: 서브쿼리의 결과 중 하나라도 같은 것이 있으면 참

JPA 서브 쿼리 한계
- JPA는 WHERE, HAVING 절에서만 서브 쿼리 사용가능(표준)
- SELECT절도 가능(하이버네이트에서 지원)
- FROM 절의 서브 쿼리는 현재 JPQL에서 불가능
    - 조인으로 풀 수 있으면 풀어서 해결




    
---
참고
https://www.inflearn.com/course/ORM-JPA-Basic#